<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Tap The Beer</title>
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.js"></script>
		<script type="text/javascript" src="http://crypto-js.googlecode.com/files/2.5.3-crypto-md5.js"></script>
    </head>
    <body>
		<script type="text/javascript">
			function login() {
				jQuery.support.cors = true;
				var username = document.getElementById('username').value;
				var password = document.getElementById('password').value;
				var key = '4fb77f74cefc1d0e9429091273114839';
				var passwordHash = Crypto.MD5(password);
                var authString = btoa(username + ':' + passwordHash);
                $.ajax({
                    url: 'http://api.untappd.com/v3/checkin_test?key=' + key,
                    type: 'POST',
                    dataType: 'json',
                    beforeSend: function (xhr) { xhr.setRequestHeader('Authorization', 'Basic ' + authString); },
                    success: function (data) {
						getNearestPlaces();
						$.mobile.changePage('index.html#bars');
						//window.location = 'index.html#bars';
					},
                    error: function (jqXHR, textStatus, errorThrown) {
						getNearestPlaces();
                        console.log("jqXHR: ", jqXHR);
                        console.log("textStatus: ", textStatus);
                        console.log("errorThrown: ", errorThrown);
						alert("wrong username or password!");
                    }
                });
            }
			function createLIElements(data){
				var venues = data.response.venues;
				var Parent = document.getElementById("bar-list");
				for (var i = 0; i < venues.length; i++){
					var venue = venues[i];
					var NewLI = document.createElement("LI");
					NewLI.setAttribute('data-theme', 'c');
					var link = document.createElement("a");
					link.setAttribute("href", "#beers")
					link.setAttribute("data-transition", "slide");
					link.setAttribute('onclick', "selectPlace('" + venue.id + "')");
					var linkText = document.createTextNode(venue.name);
					link.appendChild(linkText);
					NewLI.appendChild(link);
					Parent.appendChild(NewLI);
				}
				$('.bar-list').listview('refresh');
			}
			function foursquare() {
				var latitude = '60.10';
				var longitude = '24.57';
				var foursquaretoken = '';
				$.ajax({
                    url: 'https://api.foursquare.com/v2/venues/search?ll=' + latitude + ',' + longitude + '&oauth_token=' + foursquaretoken + '&v=20120425&limit=10',
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
						createLIElements(data);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log("jqXHR: ", jqXHR);
                        console.log("textStatus: ", textStatus);
                        console.log("errorThrown: ", errorThrown);
						alert("Something wrong on Foursquare!");
                    }
                });
			}
			function getNearestPlaces() {
				foursquare();
			}
			
			function selectPlace(foursquareid){
				alert(foursquareid);
				//Request the untappd id based on foursquareid
				//Update the beer list according to the selection
			}
			function checkIn(){
				alert("Done");
			}
		</script>
		<div data-role="page" data-theme="b" id="login">
			<form>
				<p>Username: <input type="text" name="username" id="username" size="25" required/></p>
				<p>Password: <input type="password" name="password" id="password" size="25" required/></p>
				<a onclick="login()" href="#" data-role="button">Login</a>
			</form>
		</div>
        <div data-role="page" data-theme="b" id="bars">
            <div data-theme="b" data-role="header">
                <h3>
                    Tap The Beer
                </h3>
            </div>
            <div data-role="content">
                <ul class="bar-list" id="bar-list" data-role="listview" data-divider-theme="b" data-inset="true">
                    <li data-role="list-divider" role="heading">
                        Bars
                    </li>
					<li data-theme="c">
						<a href="#beers" onclick="selectPlace('4b7c2f17f964a520c3822fe3')">Venture Garage</a>
					</li>
                </ul>
            </div>
        </div>
		<div data-role="page" data-theme="b" id="beers">
			<div data-role="content">
                <ul data-role="listview" data-divider-theme="b" data-inset="true">
                    <li data-role="list-divider" role="heading">
                        Beers
                    </li>
                    <li data-theme="c">
                        <a href="#page1" onclick="checkIn()" data-transition="slide">
                            Koff
                        </a>
                    </li>
                    <li data-theme="c">
                        <a href="#page1" data-transition="slide">
                            Karjala
                        </a>
                    </li>
                    <li data-theme="c">
                        <a href="#page1" data-transition="slide">
                            Poron kusi
                        </a>
                    </li>
                    <li data-theme="c">
                        <a href="#page1" data-transition="slide">
                            Random
                        </a>
                    </li>
                </ul>
            </div>
		</div>
    </body>
</html>